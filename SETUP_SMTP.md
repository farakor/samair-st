# Настройка SMTP для отправки писем

Этот документ содержит инструкции по настройке SMTP для автоматической отправки приветственных писем с паролями новым пользователям.

## Что было добавлено

### 1. Серверная часть
- **emailService.js**: Добавлены методы для работы с SMTP
  - `loadSMTPConfig()` - загрузка SMTP конфигурации
  - `saveSMTPConfig()` - сохранение SMTP конфигурации
  - `createSMTPTransporter()` - создание SMTP транспорта
  - `testSMTPConnection()` - тестирование SMTP подключения
  - `sendWelcomeEmail()` - отправка приветственного письма новому пользователю

- **server.js**: Добавлены API endpoints
  - `GET /api/smtp-config` - получение SMTP настроек
  - `POST /api/smtp-config` - сохранение SMTP настроек
  - `POST /api/test-smtp-connection` - тестирование SMTP подключения
  - `POST /api/send-welcome-email` - отправка приветственного письма

### 2. Клиентская часть
- **AuthContext.jsx**: Обновлена функция `addUser()` для автоматической отправки приветственного письма
- **UsersManagement.jsx**: Обновлен для работы с асинхронной функцией создания пользователя
- **EmailSettings.jsx**: Добавлена вкладка SMTP с интерфейсом для настройки

### 3. Зависимости
- Добавлен пакет `nodemailer@^6.9.8` в package.json

## Как настроить SMTP

### Шаг 1: Запустите сервер
```bash
npm run dev
```

### Шаг 2: Откройте настройки почты
1. Войдите в систему как суперадмин
2. Перейдите в "Настройки почты" в боковом меню
3. Выберите вкладку "SMTP (Отправка)"

### Шаг 3: Заполните SMTP настройки

#### Для Gmail:
- **SMTP Сервер**: smtp.gmail.com
- **Порт**: 587
- **Email адрес**: ваш Gmail адрес
- **Пароль**: пароль приложения (НЕ основной пароль)
- **Имя отправителя**: SamAir System (или любое другое)
- **SSL**: оставить выключенным (используется STARTTLS)

#### Для Yandex:
- **SMTP Сервер**: smtp.yandex.ru
- **Порт**: 587
- **Email адрес**: ваш Yandex адрес
- **Пароль**: пароль от почты
- **Имя отправителя**: SamAir System
- **SSL**: оставить выключенным

#### Для Outlook/Hotmail:
- **SMTP Сервер**: smtp.office365.com
- **Порт**: 587
- **Email адрес**: ваш Outlook адрес
- **Пароль**: пароль от аккаунта
- **Имя отправителя**: SamAir System
- **SSL**: оставить выключенным

### Шаг 4: Тестирование
1. Нажмите кнопку "Тестировать SMTP" для проверки подключения
2. Если тест прошел успешно, нажмите "Сохранить SMTP"

## Настройка для Gmail (подробно)

### Включение двухфакторной аутентификации
1. Перейдите в настройки Google аккаунта
2. Выберите "Безопасность"
3. Включите "Двухэтапная аутентификация"

### Создание пароля приложения
1. В разделе "Безопасность" найдите "Пароли приложений"
2. Выберите приложение "Почта" и устройство "Другое"
3. Введите название "SamAir System"
4. Скопируйте сгенерированный пароль
5. Используйте этот пароль в настройках SMTP

## Как работает система

### При создании пользователя:
1. Генерируется случайный пароль
2. Пользователь сохраняется в системе
3. Автоматически отправляется приветственное письмо с:
   - Данными для входа (email и пароль)
   - Красивым оформлением в стиле SamAir
   - Рекомендацией сменить пароль

### Структура письма:
- Профессиональный дизайн в стиле Air Samarkand с официальным логотипом
- Адаптивная HTML-верстка с корпоративными цветами (#1B3B7B) 
- Персональное обращение к пользователю
- Четко выделенные учетные данные в рамке
- Предупреждение о смене пароля с иконкой
- Встроенные изображения (логотип, иконки)
- Мобильная адаптация
- Контактная информация

## Логирование

Все операции с SMTP логируются в файл `server/data/config/email-logs.json`:
- Успешные отправки писем
- Ошибки SMTP подключения
- Тесты подключения

Логи можно просматривать в разделе "Логи почты" в интерфейse.

## Устранение неполадок

### Ошибка аутентификации
- Проверьте правильность email и пароля
- Для Gmail убедитесь, что используете пароль приложения
- Проверьте, что двухфакторная аутентификация включена

### Ошибка подключения
- Проверьте настройки SMTP сервера и порта
- Убедитесь, что у вас есть интернет-соединение
- Проверьте, что не блокируется файрволом

### Письма не доходят
- Проверьте папку "Спам" у получателя
- Убедитесь, что SMTP настройки сохранены и протестированы
- Проверьте логи в разделе "Логи почты"

## Безопасность

- Пароли от SMTP не сохраняются в логах
- Используйте пароли приложений вместо основных паролей
- Регулярно проверяйте логи на подозрительную активность
- Рекомендуется использовать отдельный email аккаунт для системных уведомлений

## Шаблон письма

Система использует профессиональный HTML шаблон, расположенный в `email-temp/welcome_user_template.html`:

### Особенности шаблона:
- **Корпоративный дизайн** с логотипом Air Samarkand
- **Переменные шаблона**: `{{userName}}`, `{{userEmail}}`, `{{password}}`
- **Встроенные изображения** через CID attachments
- **Адаптивная верстка** для мобильных устройств
- **Корпоративные цвета** Air Samarkand (#1B3B7B)

### Файлы шаблона:
- `email-temp/welcome_user_template.html` - основной HTML шаблон
- `email-temp/images/air-samarkand-logo.png` - логотип компании
- `email-temp/images/vpn_key-48-primary.png` - иконка ключа
- `email-temp/images/person-24-light.png` - иконка пользователя

## Дополнительные возможности

В будущем можно добавить:
- Шаблоны писем для различных событий
- Отправка уведомлений о других событиях системы  
- Редактор шаблонов в веб-интерфейсе
- Массовая отправка уведомлений